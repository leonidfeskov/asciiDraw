<!DOCTYPE html>
<html>
<head>
	<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
	<title>Pixel</title>
	<style>
		html, body {margin: 0;}
		.pic {
			font-family: monospace;
			white-space: pre;
			font-size: 12px;
		}
	</style>
</head>
<body>
	<div class="pic"></div>
	<script>
		//var ASCIIColors = ['#', '@', '%', '$', 'W', 'C', 'u', '>', '=', '+', '*', ':', '-', ',', '.', ' '];
		var ASCIIColors = ['#', '@', '%', '=', '+', '*', ':', '-', '.', ' '];
		var limit = 1000000;
		var pictures = ['mts.png', 'picture.png', 'picture-small.png'];
		var activePic = 0;

		var loadTexture = function (name, then) {
			var texture = new Image();
			var result = {};

			// on load
			texture.addEventListener('load', function () {
				if (this.width * this.height > limit) {
					alert('Изображение слишком большое. Максимальная плотность изображения '+limit+'px.');
					return false;
				}

				var canvas = document.createElement('canvas');
				var context = canvas.getContext('2d');
				
				canvas.width = this.width;
				canvas.height = this.height;

				result.width = this.width;
				result.height = this.height;

				context.drawImage(this, 0, 0);

				var imageData = context.getImageData(0, 0, this.width, this.height);
				var data = imageData.data;

				for(var i = 0; i < data.length; i += 4) {
					var brightness = 0.34 * data[i] + 0.5 * data[i + 1] + 0.16 * data[i + 2];
					data[i] = brightness;
					data[i + 1] = brightness;
					data[i + 2] = brightness;
				}

				// overwrite original image
				context.putImageData(imageData, 0, 0);

				result.data = context.getImageData(0, 0, this.width, this.height).data;

				then();
			}, false);

			texture.src = name;
			return result;
		};

		function drawPicture(data){
			var colors = data.data;
			var pic = document.querySelector('.pic');
			var str = '';

			for (var i = 0; i < colors.length; i+=4) {
				var color = colors[i];
				if ( i > 0 && (i % (data.width*4)) == 0 ) {
					str += '<br>';
				}
				var symbol = ASCIIColors[color > 0 ? Math.ceil(color/255*ASCIIColors.length)-1 : 0];
				str += symbol+''+symbol;

			}
			pic.innerHTML = str;
		}

		function loadPicture(src){
			var texture = loadTexture(src, function () {
				if (texture) {
					drawPicture(texture);
				}
			});
		}

		document.addEventListener('click', function(){
			loadPicture(pictures[activePic++]);
			if (activePic >= pictures.length) {
				activePic = 0;
			}
		});
	</script>
</body>
</html>